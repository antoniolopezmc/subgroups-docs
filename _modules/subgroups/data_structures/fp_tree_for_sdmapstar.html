<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>subgroups.data_structures.fp_tree_for_sdmapstar &mdash; subgroups 0.1.6 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=92fd9be5" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=6e0256f3"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            subgroups
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../project_files/subgroups.html">subgroups package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../project_files/subgroups.algorithms.html">subgroups.algorithms package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../project_files/subgroups.core.html">subgroups.core package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../project_files/subgroups.data_structures.html">subgroups.data_structures package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../project_files/subgroups.quality_measures.html">subgroups.quality_measures package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../project_files/subgroups.tests.html">subgroups.tests package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../project_files/subgroups.utils.html">subgroups.utils package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">subgroups</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">subgroups.data_structures.fp_tree_for_sdmapstar</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for subgroups.data_structures.fp_tree_for_sdmapstar</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1"># Contributors:</span>
<span class="c1">#    Paco Mora Caselles &lt;pacomoracaselles@gmail.com&gt;</span>

<span class="sd">&quot;&quot;&quot;This file contains the implementation of the FPTree data structure used in the SDMapStar algorithm.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">subgroups.data_structures.fp_tree_node</span> <span class="kn">import</span> <span class="n">FPTreeNode</span>
<span class="kn">from</span> <span class="nn">subgroups.core.selector</span> <span class="kn">import</span> <span class="n">Selector</span>
<span class="kn">from</span> <span class="nn">subgroups.core.operator</span> <span class="kn">import</span> <span class="n">Operator</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">DataFrame</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">size</span><span class="p">,</span> <span class="nb">sum</span>
<span class="kn">from</span> <span class="nn">subgroups.exceptions</span> <span class="kn">import</span> <span class="n">InconsistentMethodParametersError</span>
<span class="kn">from</span> <span class="nn">subgroups.data_structures.fp_tree_for_sdmap</span> <span class="kn">import</span> <span class="n">FPTreeForSDMap</span>
<span class="kn">from</span> <span class="nn">subgroups.quality_measures.quality_measure</span> <span class="kn">import</span> <span class="n">QualityMeasure</span>

<span class="c1"># Python annotations.</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>

<div class="viewcode-block" id="FPTreeForSDMapStar">
<a class="viewcode-back" href="../../../project_files/subgroups.data_structures.html#subgroups.data_structures.fp_tree_for_sdmapstar.FPTreeForSDMapStar">[docs]</a>
<span class="k">class</span> <span class="nc">FPTreeForSDMapStar</span><span class="p">(</span><span class="n">FPTreeForSDMap</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This class represents the FPTree data structure used in the SDMapStar algorithm.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;_TP&quot;</span><span class="p">,</span> <span class="s2">&quot;_FP&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">TP</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span><span class="n">FP</span><span class="p">:</span><span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method to initialize the FPTreeForSDMapStar</span>
<span class="sd">        :param TP: The number of true positives in the dataset.</span>
<span class="sd">        :param FP: The number of false positives in the dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">TP</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">int</span> <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The TP parameter must be an integer.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">FP</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">int</span> <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The FP parameter must be an integer.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_TP</span> <span class="o">=</span> <span class="n">TP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_FP</span> <span class="o">=</span> <span class="n">FP</span>

<div class="viewcode-block" id="FPTreeForSDMapStar.generate_conditional_fp_tree_star">
<a class="viewcode-back" href="../../../project_files/subgroups.data_structures.html#subgroups.data_structures.fp_tree_for_sdmapstar.FPTreeForSDMapStar.generate_conditional_fp_tree_star">[docs]</a>
    <span class="k">def</span> <span class="nf">generate_conditional_fp_tree_star</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">list_of_selectors</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Selector</span><span class="p">],</span> <span class="n">min_optimistic_estimate</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">optimistic_estimate</span> <span class="p">:</span> <span class="n">QualityMeasure</span> <span class="p">,</span> <span class="n">additional_parameters</span> <span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span> <span class="p">,</span> <span class="n">minimum_tp</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">minimum_fp</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">minimum_n</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="s1">&#39;FPTreeForSDMapStar&#39;</span><span class="p">,</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method to get the conditional FPTree with a list of selectors. Two threshold types could be used: (1) the true positives tp and the false positives fp separately or (2) the subgroup description size n (n = tp + fp). This means that: (1) if &#39;minimum_tp&#39; and &#39;minimum_fp&#39; have a value of type &#39;int&#39;, &#39;minimum_n&#39; must be None; and (2) if &#39;minimum_n&#39; has a value of type &#39;int&#39;, &#39;minimum_tp&#39; and &#39;minimum_fp&#39; must be None.</span>
<span class="sd">        </span>
<span class="sd">        :param list_of_selectors: the list of selectors which is used. IMPORTANT: we assume that the list of selectors only contains selectors.</span>
<span class="sd">        :param min_optimistic_estimate: the minimum optimistic estimate threshold.</span>
<span class="sd">        :param optimistic_estimate: the optimistic estimate quality measure.</span>
<span class="sd">        :param additional_parameters: the additional parameters for the optimistic estimate quality measure.</span>
<span class="sd">        :param minimum_tp: the minimum true positives (tp) threshold.</span>
<span class="sd">        :param minimum_fp: the minimum false positives (fp) threshold.</span>
<span class="sd">        :param minimum_n: the minimum subgroup description size (n) threshold.</span>
<span class="sd">        :return: the generated conditional FPTree and the number of pruned branches.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">list_of_selectors</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The type of the parameter &#39;list_of_selectors&#39; must be &#39;list&#39;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">minimum_tp</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">minimum_tp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The type of the parameter &#39;minimum_tp&#39; must be &#39;int&#39; or &#39;NoneType&#39;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">minimum_fp</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">minimum_fp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The type of the parameter &#39;minimum_fp&#39; must be &#39;int&#39; or &#39;NoneType&#39;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">minimum_n</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">minimum_n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The type of the parameter &#39;minimum_n&#39; must be &#39;int&#39; or &#39;NoneType&#39;.&quot;</span><span class="p">)</span>
        <span class="c1"># Depending on the values of the parameters &#39;minimum_tp&#39;, &#39;minimum_fp&#39; and &#39;minimum_n&#39; ...</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">minimum_tp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">minimum_fp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">minimum_n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">use_tp_and_fp</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">minimum_tp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">minimum_fp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">minimum_n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">use_tp_and_fp</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InconsistentMethodParametersError</span><span class="p">(</span><span class="s2">&quot;If &#39;minimum_tp&#39; and &#39;minimum_fp&#39; have a value of type &#39;int&#39;, &#39;minimum_n&#39; must be None; and if &#39;minimum_n&#39; has a value of type &#39;int&#39;, &#39;minimum_tp&#39; and &#39;minimum_fp&#39; must be None.&quot;</span><span class="p">)</span>
        <span class="c1"># We only use the first selector in the list in the creation process (the selector at the left side).</span>
        <span class="n">first_selector</span> <span class="o">=</span> <span class="n">list_of_selectors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># We initialize the final result.</span>
        <span class="n">final_conditional_fp_tree</span> <span class="o">=</span> <span class="n">FPTreeForSDMapStar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_TP</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_FP</span><span class="p">)</span>
        <span class="c1">### 1. Generate the conditional pattern base and a dict of frequent selectors with their selectors. ###</span>
        <span class="n">conditional_pattern_base</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># list[list[ element 1 -&gt; list[Selector], element 2 -&gt; int, element 3 -&gt; int ]]</span>
        <span class="c1"># If the first selector is not in the header table, return the current conditional FPTree.</span>
        <span class="k">if</span> <span class="n">first_selector</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header_table</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">final_conditional_fp_tree</span>
        <span class="c1"># Dictionary with all the frequent selectors (before pruning).</span>
        <span class="n">dict_of_all_frequent_selectors</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span> <span class="c1"># dict[str, tuple[Selector, list[int], int]]</span>
        <span class="c1"># Get the first node in the corresponding horizontal list.</span>
        <span class="n">current_node_in_the_horizontal_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header_table</span><span class="p">[</span><span class="n">first_selector</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># Iterate through the horizontal list.</span>
        <span class="n">insertion_order</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># The insertion order is necessary later in order to sort the elements which have the same &#39;n&#39; in a same path.</span>
        <span class="n">pruned_branches</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span><span class="p">(</span><span class="n">current_node_in_the_horizontal_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="c1"># SDMapStar pruning. We only use the nodes which have an optimistic estimate greater than the minimum optimistic estimate threshold.</span>
            <span class="c1"># Calculate the optimistic estimate.</span>
            <span class="n">current_node_tp</span> <span class="o">=</span> <span class="n">current_node_in_the_horizontal_list</span><span class="o">.</span><span class="n">counters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">current_node_fp</span> <span class="o">=</span> <span class="n">current_node_in_the_horizontal_list</span><span class="o">.</span><span class="n">counters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dict_of_parameters</span> <span class="o">=</span> <span class="p">{</span><span class="n">QualityMeasure</span><span class="o">.</span><span class="n">TRUE_POSITIVES</span> <span class="p">:</span> <span class="n">current_node_tp</span><span class="p">,</span> <span class="n">QualityMeasure</span><span class="o">.</span><span class="n">FALSE_POSITIVES</span> <span class="p">:</span> <span class="n">current_node_fp</span><span class="p">,</span> <span class="n">QualityMeasure</span><span class="o">.</span><span class="n">TRUE_POPULATION</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_TP</span><span class="p">,</span> <span class="n">QualityMeasure</span><span class="o">.</span><span class="n">FALSE_POPULATION</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FP</span><span class="p">}</span>
            <span class="n">dict_of_parameters</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">additional_parameters</span><span class="p">)</span>
            <span class="n">oe</span> <span class="o">=</span> <span class="n">optimistic_estimate</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">dict_of_parameters</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">oe</span> <span class="o">&lt;</span> <span class="n">min_optimistic_estimate</span><span class="p">:</span>
                <span class="n">current_node_in_the_horizontal_list</span> <span class="o">=</span> <span class="n">current_node_in_the_horizontal_list</span><span class="o">.</span><span class="n">_node_link</span>
                <span class="n">pruned_branches</span> <span class="o">=</span> <span class="n">pruned_branches</span> <span class="o">+</span> <span class="mi">1</span> <span class="c1"># We increase the number of pruned branches.</span>
                <span class="k">continue</span>
            <span class="c1"># Path from the root node to to the current node in the corresponding horizontal list.</span>
            <span class="n">current_path</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># Go up in the tree until the root node.</span>
            <span class="n">current_node_in_the_path</span> <span class="o">=</span> <span class="n">current_node_in_the_horizontal_list</span><span class="o">.</span><span class="n">_parent</span> <span class="c1"># We start from the parent.</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">current_node_in_the_path</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root_node</span><span class="p">):</span>
                <span class="n">current_selector</span> <span class="o">=</span> <span class="n">current_node_in_the_path</span><span class="o">.</span><span class="n">_selector</span>
                <span class="c1"># Add the selector to &#39;dict_of_all_frequent_selectors&#39;.</span>
                <span class="c1"># IMPORTANT: the true positives tp and the false positives fp of all the nodes in the path are those of the current node in the horizontal list.</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dict_of_all_frequent_selectors</span><span class="p">[</span><span class="n">current_selector</span><span class="o">.</span><span class="n">attribute_name</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="n">current_selector</span><span class="o">.</span><span class="n">value</span><span class="p">)][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="n">dict_of_all_frequent_selectors</span><span class="p">[</span><span class="n">current_selector</span><span class="o">.</span><span class="n">attribute_name</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="n">current_selector</span><span class="o">.</span><span class="n">value</span><span class="p">)][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">current_node_in_the_horizontal_list</span><span class="o">.</span><span class="n">_counters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">dict_of_all_frequent_selectors</span><span class="p">[</span><span class="n">current_selector</span><span class="o">.</span><span class="n">attribute_name</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="n">current_selector</span><span class="o">.</span><span class="n">value</span><span class="p">)][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="n">dict_of_all_frequent_selectors</span><span class="p">[</span><span class="n">current_selector</span><span class="o">.</span><span class="n">attribute_name</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="n">current_selector</span><span class="o">.</span><span class="n">value</span><span class="p">)][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">current_node_in_the_horizontal_list</span><span class="o">.</span><span class="n">_counters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="c1"># Try to access to the entry and if it does not exist, create a new one.</span>
                    <span class="n">dict_of_all_frequent_selectors</span><span class="p">[</span><span class="n">current_selector</span><span class="o">.</span><span class="n">attribute_name</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="n">current_selector</span><span class="o">.</span><span class="n">value</span><span class="p">)]</span> <span class="o">=</span> \
                        <span class="p">(</span><span class="n">current_selector</span><span class="p">,</span> <span class="p">[</span><span class="n">current_node_in_the_horizontal_list</span><span class="o">.</span><span class="n">_counters</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">current_node_in_the_horizontal_list</span><span class="o">.</span><span class="n">_counters</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">insertion_order</span><span class="p">)</span>
                    <span class="n">insertion_order</span> <span class="o">=</span> <span class="n">insertion_order</span> <span class="o">-</span> <span class="mi">1</span> <span class="c1"># IMPORTANT: in this case, the insertion order decreases (we use negative numbers) because, when we create the conditional pattern base, we iterate from the bottom to the top in the FPTree.</span>
                <span class="c1"># Insert the selector at the beginning of the current path.</span>
                <span class="n">current_path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">current_selector</span><span class="p">)</span>
                <span class="c1"># Go up.</span>
                <span class="n">current_node_in_the_path</span> <span class="o">=</span> <span class="n">current_node_in_the_path</span><span class="o">.</span><span class="n">_parent</span>
            <span class="c1"># If the path is not empty.</span>
            <span class="k">if</span> <span class="n">current_path</span><span class="p">:</span>
                <span class="c1"># Append to &#39;conditional_pattern_base&#39;.</span>
                <span class="n">conditional_pattern_base</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span> <span class="n">current_path</span><span class="p">,</span> <span class="n">current_node_in_the_horizontal_list</span><span class="o">.</span><span class="n">_counters</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">current_node_in_the_horizontal_list</span><span class="o">.</span><span class="n">_counters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">]</span> <span class="p">)</span>
            <span class="c1"># Finally, go the the next node in the horizontal list.</span>
            <span class="n">current_node_in_the_horizontal_list</span> <span class="o">=</span> <span class="n">current_node_in_the_horizontal_list</span><span class="o">.</span><span class="n">_node_link</span>
        <span class="c1">### 2. Prune the dict of frequent selectors (depending on the values of the parameters &#39;minimum_tp&#39;, &#39;minimum_fp&#39; and &#39;minimum_n&#39;). ###</span>
        <span class="n">dict_of_frequent_selectors</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span> <span class="c1"># dict[str, tuple[Selector, list[int], int]]</span>
        <span class="k">if</span> <span class="n">use_tp_and_fp</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dict_of_all_frequent_selectors</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">dict_of_all_frequent_selectors</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">minimum_tp</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dict_of_all_frequent_selectors</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">minimum_fp</span><span class="p">):</span>
                    <span class="n">dict_of_frequent_selectors</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dict_of_all_frequent_selectors</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">dict_of_all_frequent_selectors</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">dict_of_all_frequent_selectors</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dict_of_all_frequent_selectors</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dict_of_all_frequent_selectors</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">dict_of_all_frequent_selectors</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">dict_of_all_frequent_selectors</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">minimum_n</span><span class="p">):</span>
                    <span class="n">dict_of_frequent_selectors</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dict_of_all_frequent_selectors</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">dict_of_all_frequent_selectors</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">dict_of_all_frequent_selectors</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dict_of_all_frequent_selectors</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span> 
        <span class="c1">### 3. Insert all the paths of the conditional pattern base in the tree. ###</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">conditional_pattern_base</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">tp</span> <span class="o">=</span> <span class="n">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">fp</span> <span class="o">=</span> <span class="n">elem</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">valid_selectors_in_this_path</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Only the valid selectors after pruning.</span>
            <span class="c1"># Iterate through the selectors in the path.</span>
            <span class="k">for</span> <span class="n">selector</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
                <span class="c1"># Add the selector to &#39;valid_selectors_in_this_path&#39;.</span>
                <span class="c1"># ===&gt; IMPORTANT: the selector might not exist because it was pruned. In this case, a KeyError exception is raised.</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># IMPORTANT: we use &#39;repr&#39; in order to add simple quotes to the values of type str, but not to the values of numeric types.</span>
                    <span class="n">valid_selectors_in_this_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">dict_of_frequent_selectors</span><span class="p">[</span><span class="n">selector</span><span class="o">.</span><span class="n">attribute_name</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="n">selector</span><span class="o">.</span><span class="n">value</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">pass</span> <span class="c1"># If the exception is raised, we do nothing.</span>
            <span class="c1"># We sort &#39;valid_selectors_in_this_path&#39; according to the value of &#39;n&#39; (tp+fp) in the set of frequent selectors (CRITERION EXTRACTED FROM VIKAMINE).</span>
            <span class="c1"># - In case of tie, we NEED TO MAINTAIN the order of the selectors according to the order in the set of frequent selectors. For this reason, it is necessary to sort twice.</span>
            <span class="c1"># IMPORTANT: we use &#39;repr&#39; in order to add simple quotes to the values of type str, but not to the values of numeric types.</span>
            <span class="n">valid_selectors_in_this_path</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">valid_selectors_in_this_path</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">dict_of_frequent_selectors</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">attribute_name</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="p">)][</span><span class="mi">2</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># key -&gt; [2] : the insertion order in the dictionary.</span>
            <span class="n">valid_selectors_in_this_path</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">valid_selectors_in_this_path</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="p">(</span><span class="n">dict_of_frequent_selectors</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">attribute_name</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="p">)][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">dict_of_frequent_selectors</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">attribute_name</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="p">)][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># key -&gt; &#39;n&#39; : sum of tp and fp.</span>
            <span class="c1"># Insert.</span>
            <span class="n">final_conditional_fp_tree</span><span class="o">.</span><span class="n">_insert_in_conditional_fp_tree</span><span class="p">(</span><span class="n">valid_selectors_in_this_path</span><span class="p">,</span> <span class="n">final_conditional_fp_tree</span><span class="o">.</span><span class="n">_root_node</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>
        <span class="c1"># Finally, we create the sorted header table.</span>
        <span class="n">final_conditional_fp_tree</span><span class="o">.</span><span class="n">_sorted_header_table</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">final_conditional_fp_tree</span><span class="o">.</span><span class="n">_header_table</span><span class="p">:</span>
            <span class="n">final_conditional_fp_tree</span><span class="o">.</span><span class="n">_sorted_header_table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">key</span> <span class="p">)</span>
        <span class="c1"># IMPORTANT: THIS CRITERION HAS BEEN EXTRACTED FROM THE ORIGINAL IMPLEMENTATION OF THE SDMAP ALGORITHM (IN VIKAMINE).</span>
        <span class="c1"># We have to sort the selectors according to the summation of &#39;n&#39; (i.e., summation of tp + summation of fp).</span>
        <span class="c1"># - In case of tie, we maintain the insertion order in the dictionary &#39;header_table&#39;.</span>
        <span class="n">final_conditional_fp_tree</span><span class="o">.</span><span class="n">_sorted_header_table</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="p">(</span><span class="n">final_conditional_fp_tree</span><span class="o">.</span><span class="n">_header_table</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">final_conditional_fp_tree</span><span class="o">.</span><span class="n">_header_table</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span> <span class="c1"># Ascending order.</span>
        <span class="c1"># Return the final conditional FPTree.</span>
        <span class="k">return</span> <span class="n">final_conditional_fp_tree</span><span class="p">,</span> <span class="n">pruned_branches</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Antonio López Martínez-Carrasco.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>